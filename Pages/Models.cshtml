@page
@model TinyGenerator.Pages.ModelsModel
@{
    ViewData["Title"] = "Models";
    ViewData["PageDescription"] = "Gestisci i modelli e i test delle funzioni";
    var groupsHeader = Model.TestGroups ?? new System.Collections.Generic.List<string>();
    var visibleGroups = groupsHeader.Take(4).ToList();
}

<div class="mb-3 d-flex gap-2 align-items-center">
    <a class="btn btn-sm btn-primary" href="/Models/Edit">Nuovo modello</a>

    <div class="input-group input-group-sm" style="width:260px">
        <select id="groupSelect" class="form-select">
            @foreach(var g in Model.TestGroups ?? new System.Collections.Generic.List<string>())
            {
                <option value="@g">@g</option>
            }
        </select>
        <button id="runGroupBtn" class="btn btn-outline-secondary">Run Group</button>
    </div>

    <button id="runAllBtn" class="btn btn-sm btn-outline-success">Run All</button>
    <button id="purgeOllamaBtn" class="btn btn-sm btn-outline-danger">Purge disabled Ollama</button>
    <button id="refreshContextsBtn" class="btn btn-sm btn-outline-secondary">Refresh contexts</button>
    <button id="discoverOllamaBtn" class="btn btn-sm btn-outline-secondary">Discover Ollama models</button>
    <button id="recalculateScoresBtn" class="btn btn-sm btn-outline-info"><i class="bi bi-calculator"></i> Ricalcola punteggi</button>

    <label class="form-check form-check-inline ms-2">
        <input id="showDisabledCheckbox" class="form-check-input" type="checkbox" @(Model.ShowDisabled ? "checked" : "") />
        <span class="form-check-label">Mostra anche disabilitati</span>
    </label>

    <div class="ms-auto d-flex align-items-center gap-2">
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="columnToggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-eye"></i> Colonne
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="columnToggle" id="columnToggleMenu">
                <!-- Populated by JavaScript -->
            </ul>
        </div>
        
    </div>
</div>

<div class="models-table-wrapper">
    <table id="modelsTable" class="table table-sm table-striped">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Provider</th>
                <th>Local</th>
                <th>MaxContext</th>
                <th>ContextToUse</th>
                <th class="text-center">Score</th>
                <th class="text-center">NoTools</th>
                <th class="text-center">Duration (s)</th>
                @foreach (var g in visibleGroups) { <th class="text-center">@g</th> }
                <th class="text-center">Writer</th>
                <th class="text-center">TTS</th>
                <th class="text-end">Cost In $/1k</th>
                <th class="text-end">Cost Out $/1k</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in Model.Models ?? new System.Collections.Generic.List<TinyGenerator.Models.ModelInfo>())
            {
                <tr data-model="@m.Name">
                    <td class="dt-control"></td>
                    <td>@m.Name</td>
                    <td>
                        @if (m.Provider?.Equals("ollama", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <span class="badge bg-success">@m.Provider</span>
                        }
                        else if (m.Provider?.Equals("openai", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <span class="badge bg-warning text-dark">@m.Provider</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@m.Provider</span>
                        }
                    </td>
                    <td>@(m.IsLocal ? "Yes" : "No")</td>
                    <td>@m.MaxContext</td>
                    <td>@m.ContextToUse</td>
                    <td class="text-center">@m.FunctionCallingScore</td>
                    <td class="text-center">@(m.NoTools ? "✓" : "")</td>
                    <td class="text-center">@(m.TestDurationSeconds.HasValue ? String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.##}", m.TestDurationSeconds.Value) : "-")</td>
                    @foreach (var g in visibleGroups) { <td class="text-center">@(m.LastGroupScores != null && m.LastGroupScores.TryGetValue(g, out var sc) && sc.HasValue ? sc.Value.ToString() : "-")</td> }
                    <td class="text-center">@(m.WriterScore > 0 ? String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.#}", m.WriterScore) : "-")</td>
                    <td class="text-center">@(m.LastGroupScores != null && m.LastGroupScores.TryGetValue("tts", out var ttsScore) && ttsScore.HasValue ? ttsScore.Value.ToString() : "-")</td>
                    <td class="text-end">@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.#####}", m.CostInPerToken)</td>
                    <td class="text-end">@String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:0.#####}", m.CostOutPerToken)</td>
                    <td class="text-end">
                        <div class="btn-group" role="group">
                            <a class="btn btn-sm btn-outline-secondary" href="/Models/Edit?name=@System.Net.WebUtility.UrlEncode(m.Name)">Edit</a>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Run</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item run-model-all" href="#" data-model="@m.Name">All tests</a></li>
                                    @foreach(var g in Model.TestGroups ?? new System.Collections.Generic.List<string>())
                                    {
                                        <li><a class="dropdown-item run-model-group" href="#" data-model="@m.Name" data-group="@g">@g</a></li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

    <!-- Include DataTables from CDN (CSS + JS). If your layout already provides these, duplicates are harmless in dev. -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function(){
            // Function to format child row content
            function formatChildRow(model) {
                return '<div class="test-details-container p-3" style="background-color: #f8f9fa;" data-model="' + model + '">' +
                       '<div class="test-groups-loading">Loading test results...</div>' +
                       '</div>';
            }

            var table = $('#modelsTable').DataTable({
                paging: true,
                info: true,
                searching: true,
                ordering: true,
                stateSave: true,
                stateSaveName: 'DataTables_models',
                stateDuration: -1,
                order: [[6, 'desc']], // Score column (now index 6 because of chevron column + MaxContext)
                columnDefs: [ 
                    { targets: 0, orderable: false, className: 'dt-control' },
                    { targets: 'no-sort', orderable: false }
                ]
            });

                // Ripristina esplicitamente la visibilità delle colonne salvata in localStorage
                (function() {
                    try {
                        var savedCols = localStorage.getItem('DataTables_models_columns');
                        if (savedCols) {
                            var cols = JSON.parse(savedCols);
                            if (Array.isArray(cols)) {
                                table.columns().every(function(idx) {
                                    var colState = cols[idx];
                                    if (colState && typeof colState.visible !== 'undefined') {
                                        // Forza lo stato di visibilità (coerente sia con saved object completo che con array di {visible:bool})
                                        this.visible(!!colState.visible);
                                    }
                                });
                            }
                        }
                    } catch(e) {
                        console.error('Error restoring column visibility:', e);
                    }
                })();

            // Populate column visibility toggle menu
            var columnToggleMenu = $('#columnToggleMenu');
            table.columns().every(function(index) {
                var column = this;
                var header = $(column.header());
                var title = header.text().trim();
                
                // Skip first column (expand control) and actions column
                if (index === 0 || title === '' || header.parent().children().last()[0] === header[0]) {
                    return;
                }
                
                var li = $('<li>');
                var label = $('<label class="dropdown-item">');
                var checkbox = $('<input type="checkbox" class="form-check-input me-2">')
                    .prop('checked', column.visible()) // Sincronizza con stato salvato
                    .on('change', function() {
                        column.visible(this.checked);
                        // Save state after column visibility change
                        var state = { columns: [] };
                        table.columns().every(function() {
                            state.columns.push({ visible: this.visible() });
                        });
                        localStorage.setItem('DataTables_models_columns', JSON.stringify(state.columns));
                    });
                
                label.append(checkbox).append(title);
                li.append(label);
                columnToggleMenu.append(li);
            });

            // Handle click on td.dt-control to expand/collapse child row
            $('#modelsTable tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);
                var model = tr.data('model');

                if (row.child.isShown()) {
                    // Close this row
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    // Open this row
                    row.child(formatChildRow(model)).show();
                    tr.addClass('shown');
                    
                    // Load test groups
                    var container = $(row.child()).find('.test-details-container');
                    loadTestGroups(model, container);
                }
            });

            function postHandler(handler, data) {
                return fetch('?handler=' + handler, { method: 'POST', headers: { 'Accept': 'application/json' }, body: data });
            }

            $('#runGroupBtn').on('click', function(){
                var group = $('#groupSelect').val();
                var model = null; // run for all? We use RunGroup with model param when run per-model; for global group run we call RunAll
                // For convenience run the selected group for all enabled models via RunAll with group param
                var form = new FormData();
                form.append('group', group);
                postHandler('RunAll', form)
                    .then(r => r.json())
                    .then(j => { 
                        // Monitor test completion and reload page when done
                        if (j.runIds && j.runIds.length > 0) {
                            monitorTestCompletion(j.runIds);
                        }
                    })
                    .catch(e => { alert('Error starting run: ' + e); });
            });

            $('#runAllBtn').on('click', function(){
                var group = $('#groupSelect').val();
                var form = new FormData();
                if(group) form.append('group', group);
                postHandler('RunAll', form)
                    .then(r => r.json())
                    .then(j => { 
                        if (j.runIds && j.runIds.length > 0) {
                            monitorTestCompletion(j.runIds);
                        }
                    })
                    .catch(e => { alert('Error starting run: ' + e); });
            });

            $('#purgeOllamaBtn').on('click', function(){
                if(!confirm('Permanently purge disabled local Ollama models? This will attempt to delete installed models.')) return;
                postHandler('PurgeDisabledOllama', new FormData())
                    .then(r => r.json())
                    .then(j => { alert('Purge completed. Check logs for details.'); })
                    .catch(e => { alert('Error purging: ' + e); });
            });

            $('#refreshContextsBtn').on('click', function(){
                postHandler('RefreshContexts', new FormData())
                    .then(r => { if(r.redirected) window.location = r.url; else return r.json(); })
                    .then(j => { if(j) alert('Refresh contexts result: ' + JSON.stringify(j)); })
                    .catch(e => { alert('Error refreshing contexts: ' + e); });
            });

            $('#discoverOllamaBtn').on('click', function(){
                postHandler('AddOllamaModels', new FormData())
                    .then(r => { if(r.redirected) window.location = r.url; else return r.json(); })
                    .then(j => { if(j) alert('Discover result: ' + JSON.stringify(j)); else window.location.reload(); })
                    .catch(e => { alert('Error discovering: ' + e); });
            });

            $('#recalculateScoresBtn').on('click', function(){
                if(!confirm('Ricalcolare i punteggi writer per tutti i modelli?')) return;
                postHandler('RecalculateScores', new FormData())
                    .then(r => { if(r.redirected) window.location = r.url; else window.location.reload(); })
                    .catch(e => { alert('Error recalculating: ' + e); });
            });

            // ShowDisabled checkbox: update querystring and reload while preserving other params
            $('#showDisabledCheckbox').on('change', function(){
                try {
                    var params = new URLSearchParams(window.location.search);
                    if(this.checked) params.set('showDisabled', 'true'); else params.delete('showDisabled');
                    // Preserve selected group param if present in UI
                    var group = $('#groupSelect').val();
                    if(group) params.set('group', group);
                    var qs = params.toString();
                    window.location.search = qs;
                } catch(e) { console.error(e); window.location.reload(); }
            });

            // Groups available from server
            var allGroups = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TestGroups ?? new System.Collections.Generic.List<string>()));

            // Per-row dropdown: run a single group for the selected model
            // Use delegated event handlers so bindings survive DataTables DOM manipulations
            $('#modelsTable').on('click', '.run-model-group', function(e){
                e.preventDefault();
                var model = $(this).data('model');
                var group = $(this).data('group');
                var form = new FormData();
                form.append('model', model);
                if(group) form.append('group', group);
                postHandler('RunGroup', form)
                    .then(r => r.json())
                    .then(j => { 
                        if(j.runId) {
                            monitorTestCompletion([j.runId]);
                        }
                    })
                    .catch(e => { alert('Error starting run: ' + e); });
            });

            // Per-row dropdown: run ALL groups for the selected model (start one RunGroup per group)
            $('#modelsTable').on('click', '.run-model-all', function(e){
                e.preventDefault();
                var model = $(this).data('model');
                var groups = allGroups || [];
                var runIds = [];
                var promises = [];
                try {
                    for(var i=0;i<groups.length;i++){
                        var g = groups[i];
                        var form = new FormData();
                        form.append('model', model);
                        form.append('group', g);
                        var promise = postHandler('RunGroup', form)
                            .then(r => r.json())
                            .then(j => { if(j.runId) runIds.push(j.runId); })
                            .catch(()=>{});
                        promises.push(promise);
                    }
                    Promise.all(promises).then(() => {
                        if(runIds.length > 0) {
                            monitorTestCompletion(runIds);
                        }
                    });
                } catch(e) { console.error(e); }
            });

            function loadTestGroups(model, container) {
                fetch('/Models?handler=TestGroups&model=' + encodeURIComponent(model))
                    .then(r => {
                        if(!r.ok) throw new Error('HTTP ' + r.status);
                        return r.json();
                    })
                    .then(groups => {
                        if(!groups || !Array.isArray(groups) || groups.length === 0) {
                            container.html('<div class="text-muted">No test results available for this model.</div>');
                            return;
                        }
                        
                        var html = '<div class="test-groups">';
                        groups.forEach(function(group) {
                            var passRate = group.total > 0 ? Math.round((group.passed / group.total) * 100) : 0;
                            var statusColor = group.success ? 'success' : 'warning';
                            
                            html += '<div class="card mb-2">';
                            html += '<div class="card-header bg-' + statusColor + ' bg-opacity-10">';
                            html += '<button class="btn btn-link p-0 text-decoration-none w-100 text-start load-group-steps" data-model="' + model + '" data-group="' + group.group + '">';
                            html += '<strong>' + group.group + '</strong> ';
                            html += '<span class="badge bg-' + statusColor + '">' + group.score + '/10</span> ';
                            html += '<span class="text-muted small">(' + group.passed + '/' + group.total + ' passed, ' + passRate + '%)</span>';
                            html += '</button>';
                            html += '</div>';
                            html += '<div class="card-body collapse test-steps-container" data-model="' + model + '" data-group="' + group.group + '">';
                            html += '<div class="text-muted">Click to load details...</div>';
                            html += '</div>';
                            html += '</div>';
                        });
                        html += '</div>';
                        
                        container.html(html);
                    })
                    .catch(e => {
                        container.html('<div class="text-danger">Error loading test groups: ' + e.message + '</div>');
                    });
            }

            // Load test steps for a specific group (now works within child rows)
            $(document).on('click', '.load-group-steps', function(e){
                e.preventDefault();
                var model = $(this).data('model');
                var group = $(this).data('group');
                var stepsContainer = $('.test-steps-container[data-model="' + model + '"][data-group="' + group + '"]');
                
                if(stepsContainer.hasClass('show')) {
                    stepsContainer.collapse('hide');
                    return;
                }
                
                stepsContainer.collapse('show');
                
                // Load steps if not already loaded
                if(stepsContainer.find('.text-muted').length > 0) {
                    stepsContainer.html('<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</div>');
                    
                    fetch('/Models?handler=TestSteps&model=' + encodeURIComponent(model) + '&group=' + encodeURIComponent(group))
                        .then(r => r.json())
                        .then(steps => {
                            if(!steps || steps.length === 0) {
                                stepsContainer.html('<div class="text-muted">No steps found.</div>');
                                return;
                            }
                            
                            var html = '<div class="list-group list-group-flush">';
                            steps.forEach(function(step) {
                                var statusBadge = step.passed ? 
                                    '<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> PASSED</span>' : 
                                    '<span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> FAILED</span>';
                                
                                var itemClass = step.passed ? 'list-group-item' : 'list-group-item border-start border-danger border-3';
                                
                                html += '<div class="' + itemClass + '">';
                                html += '<div class="d-flex align-items-center mb-2">';
                                html += statusBadge + ' ';
                                html += '<strong class="ms-2">' + (step.stepName || 'Step ' + step.stepNumber) + '</strong>';
                                if(step.durationMs) {
                                    html += '<span class="ms-auto text-muted small">' + step.durationMs + 'ms</span>';
                                }
                                html += '</div>';
                                
                                if(step.prompt) {
                                    html += '<div class="mb-2">';
                                    html += '<small class="text-muted">Request:</small>';
                                    html += '<div class="p-2 bg-light rounded small" style="max-height:150px;overflow-y:auto;">';
                                    html += '<code>' + escapeHtml(step.prompt) + '</code>';
                                    html += '</div>';
                                    html += '</div>';
                                }
                                
                                if(step.response) {
                                    html += '<div class="mb-2">';
                                    html += '<small class="text-muted">Response:</small>';
                                    html += '<div class="p-2 bg-light rounded small" style="max-height:150px;overflow-y:auto;">';
                                    html += '<code>' + escapeHtml(step.response) + '</code>';
                                    html += '</div>';
                                    html += '</div>';
                                }
                                
                                if(step.error) {
                                    html += '<div class="alert alert-danger mb-0 py-1 px-2 small">';
                                    html += '<strong>Error:</strong> ' + escapeHtml(step.error);
                                    html += '</div>';
                                }
                                
                                html += '</div>';
                            });
                            html += '</div>';
                            
                            stepsContainer.html(html);
                        })
                        .catch(e => {
                            stepsContainer.html('<div class="text-danger">Error loading steps: ' + e.message + '</div>');
                        });
                }
            });

            function escapeHtml(text) {
                if(!text) return '';
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Monitor test completion via SignalR and reload page when done
            function monitorTestCompletion(runIds) {
                if(!window.signalR || !runIds || runIds.length === 0) return;
                
                var connection = new signalR.HubConnectionBuilder()
                    .withUrl('/progressHub')
                    .withAutomaticReconnect()
                    .build();
                
                var completedRuns = new Set();
                
                connection.on('ProgressAppended', function(id, message, extraClass) {
                    // Check if this is a completion message
                    if(runIds.includes(parseInt(id)) && extraClass) {
                        completedRuns.add(id);
                        
                        // Show notification
                        var notification = $('<div class="alert alert-dismissible fade show" role="alert" style="position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;max-width:500px;">');
                        
                        if(extraClass === 'success') {
                            notification.addClass('alert-success');
                            notification.css('background-color', '#d4edda');
                        } else if(extraClass === 'error') {
                            notification.addClass('alert-danger');
                            notification.css('background-color', '#f8d7da');
                        }
                        
                        notification.html(escapeHtml(message) + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>');
                        $('body').append(notification);
                        
                        // Auto-dismiss after 5 seconds
                        setTimeout(function() { notification.alert('close'); }, 5000);
                        
                        // If all runs completed, reload page after a short delay
                        if(completedRuns.size === runIds.length) {
                            setTimeout(function() {
                                connection.stop();
                                window.location.reload();
                            }, 2000);
                        }
                    }
                });
                
                connection.start().then(function() {
                    runIds.forEach(function(id) {
                        connection.invoke('JoinGroup', id.toString());
                    });
                }).catch(function(err) {
                    console.error('SignalR connection error:', err);
                });
            }
        });
    </script>

    <style>
        .dt-control {
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        .dt-control:hover {
            background-color: #f8f9fa;
        }
        .dt-control::before {
            content: '▶';
            font-size: 12px;
            transition: transform 0.2s;
            display: inline-block;
            color: #666;
        }
        tr.shown .dt-control::before {
            transform: rotate(90deg);
        }
        .test-details-container {
            border-top: 2px solid #dee2e6;
        }
        .test-groups .card {
            border-left: 3px solid #0d6efd;
        }
    </style>
