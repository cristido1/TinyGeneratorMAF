@page "{id?}"
@model TinyGenerator.Pages.TestDefinitions.EditModel
@{
    ViewData["Title"] = Model.Definition != null && Model.Definition.Id > 0 ? "Edit Test Definition" : "Create Test Definition";
}

@* Title rendered by layout using ViewData["Title"] *@


<form method="post">
    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="Definition.GroupName" class="form-label"></label>
            <input asp-for="Definition.GroupName" class="form-control" />
            <span asp-validation-for="Definition.GroupName" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.Library" class="form-label"></label>
            <input asp-for="Definition.Library" class="form-control" />
            <span asp-validation-for="Definition.Library" class="text-danger"></span>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="Definition.FunctionName" class="form-label"></label>
            <input asp-for="Definition.FunctionName" class="form-control" />
            <span asp-validation-for="Definition.FunctionName" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.Priority" class="form-label"></label>
            <input asp-for="Definition.Priority" class="form-control" />
            <span asp-validation-for="Definition.Priority" class="text-danger"></span>
        </div>
    </div>
    <div class="mb-3">
        <label asp-for="Definition.Prompt" class="form-label"></label>
        <textarea asp-for="Definition.Prompt" class="form-control" rows="6"></textarea>
        <span asp-validation-for="Definition.Prompt" class="text-danger"></span>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label asp-for="Definition.TestType" class="form-label">Test Type</label>
            <select asp-for="Definition.TestType" class="form-control">
                <option value="">(None)</option>
                @foreach (var t in Model.TestTypes ?? new string[] {})
                {
                    <option value="@t">@t</option>
                }
            </select>
            <span asp-validation-for="Definition.TestType" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="SelectedAllowedPlugins" class="form-label">Allowed Plugins</label>
            <select asp-for="SelectedAllowedPlugins" multiple class="form-control chosen-select" id="allowed_plugins">
                <option value="">(None)</option>
                @foreach (var p in Model.AvailablePlugins ?? new string[] {})
                {
                    if (Model.SelectedAllowedPlugins?.Contains(p) == true)
                    {
                        <option value="@p" selected>@p</option>
                    }
                    else
                    {
                        <option value="@p">@p</option>
                    }
                }
            </select>
            <span asp-validation-for="SelectedAllowedPlugins" class="text-danger"></span>
            <small class="form-text text-muted">Seleziona gli addin consentiti per il test. Lascia vuoto per non permettere alcun addin (il kernel sar√† avviato senza plugin).</small>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <div class="form-check">
                <input asp-for="Definition.Active" class="form-check-input" />
                <label asp-for="Definition.Active" class="form-check-label">Active</label>
            </div>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.ExecutionPlan" class="form-label">Execution Plan</label>
            <select asp-for="Definition.ExecutionPlan" class="form-control">
                <option value="">(None)</option>
                @foreach (var f in Model.PlanFiles ?? new List<string>())
                {
                    <option value="@f">@f</option>
                }
            </select>
            <span asp-validation-for="Definition.ExecutionPlan" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.JsonResponseFormat" class="form-label">JSON Response Format</label>
            <select asp-for="Definition.JsonResponseFormat" class="form-control">
                <option value="">(None)</option>
                @foreach (var f in Model.ResponseFormatFiles ?? new List<string>())
                {
                    <option value="@f">@f</option>
                }
            </select>
            <span asp-validation-for="Definition.JsonResponseFormat" class="text-danger"></span>
            <small class="form-text text-muted">Seleziona lo schema JSON (cartella <code>response_formats/</code>) per il formato di risposta atteso.</small>
        </div>
        <div class="col-md-6">
            <label asp-for="SelectedSourceFiles" class="form-label">Files to Copy</label>
            <select asp-for="SelectedSourceFiles" multiple class="form-control chosen-select" id="source_files">
                <option value="">(None)</option>
                @foreach (var f in Model.AvailableSourceFiles ?? new List<string>())
                {
                    if (Model.SelectedSourceFiles?.Contains(f) == true)
                    {
                        <option value="@f" selected>@f</option>
                    }
                    else
                    {
                        <option value="@f">@f</option>
                    }
                }
            </select>
            <span asp-validation-for="SelectedSourceFiles" class="text-danger"></span>
            <small class="form-text text-muted">Seleziona i file da copiare dalla cartella <code>test_source_files/</code> nella cartella del test. Usa <code>[test_folder]</code> nel prompt per il path assoluto.</small>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.ValidScoreRange" class="form-label">Valid Score Range</label>
            <input asp-for="Definition.ValidScoreRange" class="form-control" />
            <span asp-validation-for="Definition.ValidScoreRange" class="text-danger"></span>
            <small class="form-text text-muted">Usa <b>min-max</b> per range numerico (es: 1-5) oppure una lista separata da virgola (es: A,B,C). Il test verifica che la risposta sia numerica e rientri nel range, oppure che sia uguale a uno dei valori della lista.</small>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="timeout_seconds" class="form-label">Timeout (seconds)</label>
            <input id="timeout_seconds" class="form-control" type="number" min="0" step="1" />
            <input asp-for="Definition.TimeoutSecs" type="hidden" id="timeout_secs_hidden" />
            <span asp-validation-for="Definition.TimeoutSecs" class="text-danger"></span>
            <small class="form-text text-muted">Default: 30s for questions, 60s for TTS, 120s for writers</small>
        </div>
        <div class="col-md-6">
            <label asp-for="Definition.ExpectedPromptValue" class="form-label">Expected Prompt Value</label>
            <input asp-for="Definition.ExpectedPromptValue" class="form-control" />
            <span asp-validation-for="Definition.ExpectedPromptValue" class="text-danger"></span>
        </div>
    </div>
    <input type="hidden" asp-for="Definition.Id" />
    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-page="./Index" class="btn btn-secondary">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link href="/lib/chosen/chosen.min.css" rel="stylesheet" />
    <script src="/lib/chosen/chosen.jquery.min.js"></script>
    <script>
        (function () {
            $(function () {
                // Initialize chosen on the allowed_plugins select if the plugin is available.
                try {
                    if (window.jQuery && $.fn && $.fn.chosen) {
                        $('#allowed_plugins').chosen({
                            placeholder_text_multiple: 'Select allowed plugins or leave empty',
                            no_results_text: 'No plugin found',
                            width: '100%'
                        });
                        $('#source_files').chosen({
                            placeholder_text_multiple: 'Select files to copy or leave empty',
                            no_results_text: 'No file found',
                            width: '100%'
                        });
                    }
                    else {
                        console.warn('chosen plugin not available: skipping chosen initialization');
                    }
                }
                catch (e) {
                    console.error('Error while initializing chosen', e);
                }
                
                // Load timeout value on page load
                var timeoutSecs = parseInt($('#timeout_secs_hidden').val()) || 0;
                $('#timeout_seconds').val(timeoutSecs > 0 ? timeoutSecs : '');
                
                // Update hidden field on input change
                $('#timeout_seconds').on('input change', function() {
                    var seconds = parseInt($(this).val()) || 0;
                    $('#timeout_secs_hidden').val(seconds);
                });
                
                // Ensure conversion happens before form submit
                $('form').on('submit', function() {
                    var seconds = parseInt($('#timeout_seconds').val()) || 0;
                    $('#timeout_secs_hidden').val(seconds);
                });
            });
        })();
    </script>
}
