@page
@model TinyGenerator.Pages.OllamaMonitorModel
@{
    ViewData["Title"] = "Ollama Monitor";
    ViewData["PageDescription"] = "Monitora i modelli Ollama in esecuzione";
}

<p>Questa pagina mostra i modelli caricati da Ollama (aggiornamento automatico ogni 20s). Viene anche mostrato l'ultimo prompt inviato per ciascun modello dall'app.</p>

<button id="refreshBtn" class="btn btn-sm btn-primary">Aggiorna</button>
<table class="table mt-2">
    <thead>
        <tr>
            <th>Name</th>
            <th>Id</th>
            <th>Size</th>
            <th>Processor</th>
            <th>Context</th>
            <th>Until</th>
            <th>Actions</th>
            <th>Last prompt (preview)</th>
        </tr>
    </thead>
    <tbody id="tblBody">
    </tbody>
</table>

<script>
    async function fetchModels() {
        try {
            const res = await fetch('/OllamaMonitor?handler=Models');
            if (!res.ok) return;
            const models = await res.json();
            const body = document.getElementById('tblBody');
            body.innerHTML = '';
            for (const m of models) {
                const row = document.createElement('tr');
                // actions: input for context and a button to start model with that context
                const actionsHtml = `
                    <div class="input-group input-group-sm">
                      <input type="number" min="512" step="512" value="8192" class="form-control context-input" style="width:110px" />
                      <button class="btn btn-sm btn-outline-primary start-with-context">Start</button>
                    </div>`;

                row.innerHTML = `<td>${m.name}</td><td>${m.id}</td><td>${m.size}</td><td>${m.processor}</td><td>${m.context}</td><td>${m.until}</td><td>${actionsHtml}</td><td><button class='btn btn-sm btn-link' data-prompt='${encodeURIComponent(m.lastPrompt)}'>Preview</button> ${m.lastPrompt ? m.lastPrompt.substring(0,200) : ''}</td>`;
                body.appendChild(row);
            }
            // attach click handlers for preview buttons
            document.querySelectorAll('#tblBody button[data-prompt]').forEach(b => {
                b.addEventListener('click', e => {
                    const btn = e.currentTarget;
                    const p = decodeURIComponent(btn.getAttribute('data-prompt') || '');
                    alert(p || 'No prompt recorded');
                });
            });

            // attach handlers for Start buttons
            document.querySelectorAll('#tblBody .start-with-context').forEach((btn, idx) => {
                btn.addEventListener('click', async e => {
                    const tr = e.currentTarget.closest('tr');
                    const modelName = tr.children[0].innerText;
                    const input = tr.querySelector('.context-input');
                    const contextVal = parseInt(input.value) || 8192;
                    if (!confirm(`Start model ${modelName} with context ${contextVal}? This may use significant resources.`)) return;
                    try {
                        btn.disabled = true;
                        btn.innerText = 'Starting...';
                        const res = await fetch('/OllamaMonitor?handler=StartWithContext', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: modelName, context: contextVal })
                        });
                        const j = await res.json();
                        alert('Start command completed. Output:\n' + (j.runOutput || j.stopOutput || JSON.stringify(j)));
                    } catch (err) {
                        alert('Error starting model: ' + err);
                    } finally {
                        btn.disabled = false;
                        btn.innerText = 'Start';
                    }
                });
            });
        } catch (e) { console.error(e); }
    }

    document.getElementById('refreshBtn').addEventListener('click', () => fetchModels());
    setInterval(fetchModels, 20000);
</script>
